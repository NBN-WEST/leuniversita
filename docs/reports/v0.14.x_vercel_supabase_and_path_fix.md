# Vercel Supabase & Path Fix Report (v0.14.x)

**Date**: 2025-12-25
**Status**: VERIFIED GREEN (Local Audit)

## 1. Multiple GoTrueClient Instances Fix
**Issue**: Warning caused by multiple instantiations of `createBrowserClient` inside `useState` across components.
**Fix**: Implemented Singleton Pattern.
- Created `lib/supabase/client.ts` (exports `getSupabaseBrowserClient`).
- Refactored:
    - `app/plan/page.tsx`
    - `app/progress/page.tsx`
    - `app/results/[attemptId]/page.tsx`
    - `app/diagnostic/[examId]/page.tsx`

**Verification**: Code now calls `getSupabaseBrowserClient()` which returns the same instance for the session lifespan of the module.

## 2. Vercel 5-Minute Path Fix (Diagnostic Start)
**Issue**: `POST /api/diagnostic/start` failing in Production (likely 500 or 404).
**Root Cause**:
1.  Missing `apikey` header in the fetch call to Supabase Edge Function (often required by Gateway).
2.  Potential missing Env Vars handling (added explicit check).
3.  Error logging was minimal.

**Fix**:
- Updated `/api/diagnostic/start` and `/api/diagnostic/submit` to:
    - Check for `NEXT_PUBLIC_SUPABASE_URL` and `ANON_KEY`.
    - Include `apikey: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY` in headers.
    - Forward `Authorization` header (User Token).
    - Destructure payload explicitly.

## 3. Deployment Health Check
Updated `/api/health` to verify that Supabase Env Vars are present.
- **200 OK**: Configured.
- **503 Service Unavailable**: Missing Env Vars.

## 4. How to Verify on Vercel
1.  **Deploy**: Push this commit.
2.  **Health**: `curl -I https://leuniversita.vercel.app/api/health` (Expect 200).
3.  **Smoke**: Run `scripts/test/smoke_v2_remote.sh`.
4.  **Manual**:
    - Login as Admin.
    - Click "Inizia 5 minuti" (Diagnostic).
    - Should proceed to questions (no 404/500/loading stuck).
